name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs: # https://stackoverflow.com/questions/59175332/using-output-from-a-previous-job-in-a-new-one-in-a-github-action
      Version: ${{ steps.gitversion.outputs.SemVer }}
      CommitsSinceVersionSource: ${{ steps.gitversion.outputs.CommitsSinceVersionSource }}  
    steps:    
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 #fetch-depth is needed for GitVersion
          #Install and calculate the new version with GitVersion          
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.15
        with:
          versionSpec: 5.x
      - name: Determine Version
        uses: gittools/actions/gitversion/execute@v0.9.15
        id: gitversion # step id used as reference for output values
      - name: Display GitVersion outputs
        run: |
          echo "Version: ${{ steps.gitversion.outputs.SemVer }}"
          echo "CommitsSinceVersionSource: ${{ steps.gitversion.outputs.CommitsSinceVersionSource }}"
          
          
  # checkout the code from this branch, and then test the action from here
  test: 
    runs-on: windows-latest
    steps:    
      - name: checkout the code from this branch
        uses: actions/checkout@v3
        with: 
          ref: ${{ github.ref }}
      - name: Test this repo
        uses: ./ # the ./ runs the action.yml in this repo 
        with:
          projects: 'CP,CI,CD,CM'

  test2: 
    runs-on: ubuntu-latest
    steps:    
      - name: checkout the code from this branch
        uses: actions/checkout@v3
        with: 
          ref: ${{ github.ref }}
      - name: Test this repo
        uses: ./ # the ./ runs the action.yml in this repo 
        with:
          projects: 'CI'
